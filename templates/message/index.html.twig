{% extends 'base.html.twig' %}

{% block title %}Message index{% endblock %}

{% block body %}
    <h1>Message index</h1>

    <table id="messageTable">
        <thead>
            <tr>
                <th>Subject</th>
                <th>Sender</th>
                <th>Message</th>
                <th>Date Sent</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <a href="{{ path('send_message') }}" class="button success">Compose New Message...</a>

    <div class="reveal" id="deleteModal" data-reveal data-animation-in="slide-in-down" data-animation-out="slide-out-up">
        <h2>Delete Message</h2>
        <p>Are you sure you want to delete this message?</p>
        <button class="button" id="delete" data-msg-id data-close>Yes</button>
        <button class="button" data-close>No</button>
        <button class="close-button" data-close aria-label="Close" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script>
        function deleteMessage (id) {
            $.ajax({
                url: `{{ path('message_delete', {'messageId': 'msgId'}) }}`.replace('msgId', id),
                type: 'DELETE',
                success: function(xhr, textStatus, errorThrown) {
                    console.log('Deleted ' + id);
                    $('#messageTable').DataTable().ajax.reload();
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.log(`Failed to delete ${id}`);
                }
            });
        }
        $('#messageTable').DataTable( {
            ajax: {
                "url":          "{{ path('inbox') }}",
                "contentType":  "application/json",
                "type":         "POST",
                "dataSrc":      "",
                "async":        true,
            },
            "columns": [
                    {
                        "data": null,
                        "render": function(data, type, row) {
                            return `<a href="{{ path('message_show', {'messageId': 'msgId'}) }}">${ data.subject }</a>`.replace('msgId', data.id);
                        }
                    },
                    { "data": "sender" },
                    { "data": "message" },
                    {
                        "data": null,
                        "render": function(data, type, row) {
                            return `<time class="timeago" datetime="${ data.datesent }" title="${ data.datesent }"><span>${ jQuery.timeago(data.datesent) }</span></time>`;
                        }
                    },
                    {
                        "data": null,
                        "render": function(data, type, row) {
                            return `<button id="reply" action="" class="button primary">Reply</button>\
                                    <button data-open="deleteModal"\
                                    class="button alert" id="delete" data-msg-id="msgId"">Delete</button>`.replace('msgId', data.id);
                        }
                    }
            ]
        } );
        $("#messageTable").on('click', '#reply', function(event) {
            //TODO: add custom reply functionality here
            alert("click");
        })
        $('#messageTable').on('click', '#delete', function(event) {
            msgId = $(this).data('msgId');
            $('#deleteModal #delete').data('msg-id', msgId);
        })
        $('#deleteModal').on('click', '#delete', function(event) {
            msgId = $(event.currentTarget).data('msg-id');
            deleteMessage(msgId);
        })
    </script>
{% endblock %}